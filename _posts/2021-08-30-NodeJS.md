---
title: NodeJS에 대하여
author: Banny
date: 2021-08-30 16:49:00 +0900
categories: [NodeJS]
tags: [NodeJS]
---

## NodeJS의 내부 구조

<center>
<img alt="nodejs 내부 구조" src="https://user-images.githubusercontent.com/62047302/131296050-aefd2250-3583-433a-a7c3-b09e181de4d9.png">
</center>

<br>

노드는 <strong>v8 엔진</strong>과 함께 <strong>libuv</strong>라는 라이브러리를 사용합니다. v8과 libuv는 c와 c++로 구현되어 있다고 합니다.
libuv 라이브러리는 노드의 특성인 <strong>이벤트 기반, 논 블로킹 I/O 모델</strong>을 구현합니다.

<br>

## 이벤트 기반

이벤트 기반(event-driven)이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 말합니다.
이벤트로는 클릭이나 네트워크 요청이 있을 수 있습니다.

이런 시스템에서는 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해둬야 하는데, 이것을 이벤트 리스너에 콜백 함수를 등록한다고 표현합니다.

노드는 이벤트 기반 방식으로 동작합니다. 이벤트가 발생하면 이벤트 리스너에 등록해둔 콜백 함수가 호출이 됩니다.

<br>

## 이벤트 루프

- <strong>이벤트 루프</strong>: 이벤트 루프는 여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백 함수를 호출할지를 판답합니다. 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 루프(loop)라고 부릅니다.

- <strong>백그라운드</strong>: setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳입니다.

- <strong>태스크 큐</strong>: 이벤트 발생 후, 백그라운드에서는 태스크 큐로 타이머나 이벤트 리스너의 콜백 함수를 보냅니다. 보통은 완료된 순서대로 줄을 서 있기 때문에 큐라고 부릅니다.

<br>

<center>
<img alt="이벤트 루프" src="https://user-images.githubusercontent.com/62047302/131297840-20c8561c-75c3-4333-9010-538a727f7f2d.jpeg">
</center>

<br>

위 그림은 다음과 같습니다.

먼저 전역객체인 anomynous가 호출 스택에 들어갑니다. 그리고 setTimeout이 호출 스택에 들어갑니다.

호출 스택에 들어간 순서와 반대로 실행됩니다. 스택의 특성이지요.
setTimeout이 실행되면, 타이머와 함께 run 콜백을 백그라운드로 보내고, setTimeout은 호출 스택에서 빠집니다.

다음으로는 anonymous가 호출 스택에서 빠지고, 백그라운드에서는 3초를 센 뒤 run 함수를 태스크 큐로 보냅니다.

이벤트 루프는 호출 스택이 비어 있으면 태스크 큐에서 함수를 하나씩 가져와 호출 스택에 넣고 실행합니다.
이벤트 루프는 태스크 큐에 콜백 함수가 들어올 때가지 계속 대기합니다.

<br>

## 논블로킹 I/O

작업에는 두 가지 종류가 있습니다.
동시에 실행될 수 있는 작업, 동시에 실행될 수 없는 작업입니다.

일반 자바스크립트 코드는 동시에 실행될 수 없습니다. 하지만 자바스크립트 상에서 돌아가는 것이 아닌, I/O 작업 같은 것은 동시에 처리될 수 있습니다.

I/O는 입력(Input)/출력(Output)을 말합니다.
예로, 파일 시스텝 접근, 네트워크 요청, 데이터베이스 접근 같은 작업이 I/O의 일종입니다.
이러한 작업을 할 때 노드는 논블로킹 방식으로 처리하는 방법을 제공합니다.
즉, 이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행하는 것입니다.

<br>

<center>
<img alt="블로킹 논블로킹" src="https://user-images.githubusercontent.com/62047302/131299136-88e7258b-f866-4348-a4fa-ac8ff972eb06.jpeg">
</center>

<br>

노드는 I/O 작업을 백그라운드로 넘겨서 동시에 처리하곤 합니다. 동시에 처리될 수 있는 작업들은 최대한 묶어서 백그라운드로 넘겨야 시간을 절약할 수 있습니다.

<br>

## 싱글 스레드

- <strong>프로세스</strong>: 운영체제에서 할당하는 작업의 단위. 노드나 웹 브라우저 같은 프로그램은 개별 프로세스. 프로세스 간에는 메모리 등의 자원을 공유하지 않음.
- <strong>스레드</strong>: 프로세스 내에서 실행되는 흐름의 단위. 프로세스는 스레드를 여러 개 생성하여 여러 작업을 동시에 처리함. 스레드는 부모 프로세스의 자원을 공유함.

노드는 내부적으로 스레드를 여러 개 생성합니다. 그중에서 저희가 직접 제어할 수 있는 스레드는 하나입니다. 그래서 싱글 스레드라고 여겨집니다.

노드는 <strong>싱글 스레드, 논 블로킹 모델</strong>을 채택했습니다. 하나의 스레드를 논 블로킹 방식으로 사용하여, 혼자서 많은 작업을 처리할 수 있게 하는 것이죠.

스레드 하나로 작업을 처리한다는 것은 비효율적으로 생갈될 수 있습니다.
하지만 여러 스레드를 사용하는 멀티 스레드와 비교했을 때 장단점이 있습니다.

멀티 스레드의 경우, 요청이 많아지면 그만큼 스레드가 많아지고 요청이 줄어들면 일하지 않는 스레드가 발생하게 됩니다. 스레드를 정리하는 데에는 비용이 발생하게 됩니다.

다만 에러를 제대로 처리하지 못하면 하나뿐인 스레드가 죽어버려서 서버 전체가 멈출 수 있기 때문에 스레드를 잘 관리해야 합니다.

<br>

## 서버로서의 노드

서버에는 기본적으로 I/O 요청이 많이 발생합니다. 노드는 libuv 라이브러리를 사용해 I/O 작업을 논 블로킹 방식으로 처리합니다.
따라서 스레드 하나가 많은 수의 I/O를 감당할 수 있습니다.

하지만 CPU 부하가 큰 작업에는 적합하지 않습니다. 스레드 하나가 혼자서 감당하기 어렵기 때문입니다.

그런 특성 때문에, 노드는 개수는 많지만 크기는 작은 데이터를 실시간으로 주고받는 데에 적합합니다.
네트워크나 데이터베이스 작업 같은 I/O에 특화되어 있기 때문입니다. 실시간 채팅 어플이나 주식 차트, JSON 데이터를 제공하는 api 서버가 노드를 많이 사용합니다.

이미지나 비디오 처리, 대규모 데이터 처리처럼 CPU를 많이 사용하는 작업은 노드에 적합하지 않습니다.

<br>

## 노드의 장단점

다음의 표와 같습니다.

<center>
<img alt="노드의 장단점" src="https://user-images.githubusercontent.com/62047302/131301848-92c74edb-83ee-443d-8869-04e11c1a607f.png">
</center>

<br>
<br>
참고: <a href="http://www.yes24.com/Product/Goods/62597864">Node.js 교과서 - 조현영</a>
